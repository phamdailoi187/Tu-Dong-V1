<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Si√™u Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: 2rem 0;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1400px;
        }

        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            margin-bottom: 2rem;
            color: white;
        }

        .header-card h2 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0;
        }

        .header-card .fa-crown {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .btn-account {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .btn-account:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-logout {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: none;
        }

        .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }

        .btn-reload {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-reload:hover {
            transform: rotate(180deg);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-add-hospital {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
            transition: all 0.3s ease;
        }

        .btn-add-hospital:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
        }

        .table {
            margin: 0;
        }

        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table thead th {
            border: none;
            padding: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }

        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .badge-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .badge-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-action {
            border-radius: 10px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            border: none;
            margin: 0 2px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .btn-lock {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
        }

        .btn-lock:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(246, 211, 101, 0.4);
        }

        .btn-delete {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            border-radius: 20px 20px 0 0;
            border: none;
        }

        .modal-header.bg-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .modal-header.bg-warning {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }

        .modal-header.bg-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .text-primary {
            color: #667eea !important;
        }

        .hospital-name {
            font-weight: 700;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .hospital-name:hover {
            color: #764ba2;
            text-shadow: 0 0 5px rgba(118, 75, 162, 0.3);
        }

        .admin-link {
            color: #4facfe;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            color: #00f2fe;
            text-shadow: 0 0 5px rgba(0, 242, 254, 0.3);
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-card d-flex justify-content-between align-items-center">
            <h2 class="fw-bold"><i class="fas fa-crown"></i> Si√™u Admin - Qu·∫£n L√Ω B·ªánh Vi·ªán</h2>
            <div>
                <button onclick="openProfileModal()" class="btn btn-account text-white me-2">
                    <i class="fas fa-user-cog"></i> T√†i kho·∫£n
                </button>
                <button onclick="logout()" class="btn btn-logout text-white">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </div>

        <div class="main-card card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold"><i class="fas fa-hospital"></i> Danh s√°ch B·ªánh Vi·ªán (T·ª´ Database)</span>
                <div>
                    <button onclick="loadHospitals()" class="btn btn-sm btn-reload me-2">
                        <i class="fas fa-sync"></i> T·∫£i l·∫°i
                    </button>
                    <button class="btn btn-sm btn-add-hospital" data-bs-toggle="modal"
                        data-bs-target="#addHospitalModal">
                        <i class="fas fa-plus-circle"></i> Th√™m B·ªánh Vi·ªán
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>M√£ BV</th>
                                <th>T√™n B·ªánh Vi·ªán</th>
                                <th>ƒê·ªãa ch·ªâ / SƒêT</th>
                                <th style="min-width: 200px;">Admin ƒê·∫°i Di·ªán</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center" style="min-width: 180px;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addHospitalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-hospital-user"></i> Th√™m B·ªánh Vi·ªán & C·∫•p Admin</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-primary border-bottom pb-2 mb-3">1. Th√¥ng tin B·ªánh vi·ªán</h6>
                    <div class="row g-2">
                        <div class="col-md-4 mb-2">
                            <label class="small fw-bold">M√£ BV (*)</label>
                            <input type="text" id="hospitalCode" class="form-control form-control-sm"
                                placeholder="VD: BV_BM">
                        </div>
                        <div class="col-md-8 mb-2">
                            <label class="small fw-bold">T√™n BV (*)</label>
                            <input type="text" id="hospitalName" class="form-control form-control-sm"
                                placeholder="VD: B·ªánh Vi·ªán B·∫°ch Mai">
                        </div>
                    </div>
                    <div class="mb-2"><label class="small">ƒê·ªãa ch·ªâ</label><input type="text" id="address"
                            class="form-control form-control-sm"></div>
                    <div class="mb-3"><label class="small">Hotline</label><input type="text" id="phone"
                            class="form-control form-control-sm"></div>

                    <h6 class="text-danger border-bottom pb-2 mb-3 mt-3">2. T√†i kho·∫£n Admin ƒê·∫°i Di·ªán</h6>
                    <div class="mb-2">
                        <label class="small fw-bold">Username Admin (*)</label>
                        <input type="text" id="adminUsername" class="form-control form-control-sm">
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Email Admin (*)</label>
                        <input type="email" id="adminEmail" class="form-control form-control-sm"
                            placeholder="admin@benhvien.com">
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">M·∫≠t kh·∫©u (*)</label>
                        <input type="password" id="adminPassword" class="form-control form-control-sm">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="createHospital()">T·∫°o M·ªõi Ngay</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editHospitalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> C·∫≠p nh·∫≠t th√¥ng tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-2"><label class="fw-bold">T√™n B·ªánh Vi·ªán</label><input type="text" id="editName"
                            class="form-control"></div>
                    <div class="mb-2"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="editAddress" class="form-control">
                    </div>
                    <div class="mb-3"><label>S·ªë ƒëi·ªán tho·∫°i</label><input type="text" id="editPhone"
                            class="form-control"></div>
                    <hr>
                    <div class="mb-2 bg-light p-2 border rounded">
                        <label class="fw-bold text-danger">ƒê·ªïi m·∫≠t kh·∫©u Admin</label>
                        <small class="d-block text-muted mb-1">(ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi)</small>
                        <input type="password" id="editNewPass" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="submitUpdate()">L∆∞u Thay ƒê·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">üë§ Th√¥ng tin c√° nh√¢n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label>Username (Kh√¥ng th·ªÉ s·ª≠a)</label>
                        <input type="text" id="myUsername" class="form-control" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label>H·ªç v√† t√™n</label>
                        <input type="text" id="myFullName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="myEmail" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>M√£ nh√¢n vi√™n</label>
                        <input type="text" id="myEmployeeCode" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" id="myPhoneNumber" class="form-control">
                    </div>

                    <hr>

                    <div class="mb-3 bg-light p-3 rounded border">
                        <label class="fw-bold text-danger mb-2">
                            <i class="bi bi-shield-lock"></i> ƒê·ªïi m·∫≠t kh·∫©u
                        </label>

                        <div class="mb-2">
                            <input type="password" id="myCurrentPass" class="form-control"
                                placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i (B·∫Øt bu·ªôc n·∫øu ƒë·ªïi pass)">
                        </div>

                        <div class="mb-2">
                            <input type="password" id="myNewPass" class="form-control"
                                placeholder="M·∫≠t kh·∫©u m·ªõi (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)">
                        </div>

                        <div>
                            <input type="password" id="myConfirmPass" class="form-control"
                                placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi">
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
        if (!token) window.location.href = '/index.html';

        // --- 1. QU·∫¢N L√ù B·ªÜNH VI·ªÜN ---

        async function loadHospitals() {
            try {
                const res = await fetch('/api/super-admin/hospitals', { headers: { 'Authorization': `Bearer ${token}` } });

                // X·ª≠ l√Ω l·ªói 401/403
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        Swal.fire('L·ªói', 'H·∫øt phi√™n ƒëƒÉng nh·∫≠p!', 'error').then(() => logout());
                    }
                    return;
                }

                const json = await res.json();
                const tbody = document.getElementById('hospitalTable');
                tbody.innerHTML = '';

                json.data.forEach(hos => {
                    // -----------------------------------------------------------
                    // üëá 1. S·ª¨A L·ªñI QUAN TR·ªåNG: D√πng hos.adminInfo thay v√¨ hos.Users
                    // -----------------------------------------------------------
                    let adminDisplay = '<span class="text-muted fst-italic opacity-50">Ch∆∞a c√≥ admin</span>';
                    const admin = hos.adminInfo; // L·∫•y ƒë√∫ng bi·∫øn t·ª´ Controller tr·∫£ v·ªÅ

                    if (admin) {
                        // Logic hi·ªÉn th·ªã Role (N·∫øu backend tr·∫£ v·ªÅ Roles)
                        // L∆∞u √Ω: Controller b·∫°n ƒë·ªÉ attributes: [] ·ªü Role n√™n c√≥ th·ªÉ admin.Roles s·∫Ω r·ªóng. 
                        // T·∫°m th·ªùi m√¨nh l·∫•y t√™n m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ role.
                        const roleName = (admin.Roles && admin.Roles.length > 0) ? admin.Roles[0].name : 'Qu·∫£n tr·ªã vi√™n';

                        // Logic Permissions
                        const perms = (admin.Roles && admin.Roles.length > 0 && admin.Roles[0].Permissions)
                            ? admin.Roles[0].Permissions.map(p => p.name)
                            : [];

                        // Escape chu·ªói JSON ƒë·ªÉ tr√°nh l·ªói HTML
                        const permsData = JSON.stringify(perms).replace(/"/g, '&quot;');

                        adminDisplay = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="line-height: 1.2;">
                            <span class="fw-bold text-dark">${admin.fullName || admin.username}</span><br>
                            <small class="admin-link" style="font-size: 0.85em;">${admin.email}</small>
                        </div>
                        
                        ${perms.length > 0 ? `
                        <button onclick="showPermissions('${admin.username}', '${roleName}', ${permsData})" class="btn btn-sm btn-action btn-edit ms-2" title="Xem quy·ªÅn h·∫°n">
                            <i class="fas fa-shield-alt"></i>
                        </button>` : ''}
                    </div>
                `;
                    }

                    // -----------------------------------------------------------
                    // 2. N√∫t Tr·∫°ng th√°i (Gi·ªØ nguy√™n logic c·ªßa b·∫°n)
                    // -----------------------------------------------------------
                    const isActive = (hos.isActive !== undefined) ? hos.isActive : true;
                    const statusBadge = isActive
                        ? '<span class="badge badge-status badge-success">Ho·∫°t ƒë·ªông</span>'
                        : '<span class="badge badge-status badge-danger">ƒê√£ kh√≥a</span>';

                    const statusBtn = isActive
                        ? `<button onclick="toggleStatus(${hos.id}, false)" class="btn btn-sm btn-action btn-lock" title="Kh√≥a BV"><i class="fas fa-lock"></i></button>`
                        : `<button onclick="toggleStatus(${hos.id}, true)" class="btn btn-sm btn-action btn-lock" title="M·ªü kh√≥a BV"><i class="fas fa-lock-open"></i></button>`;

                    // -----------------------------------------------------------
                    // 3. Render H√†ng
                    // -----------------------------------------------------------
                    const row = `
                <tr>
                    <td class="text-center fw-bold text-secondary">${hos.id}</td>
                    <td><span class="badge bg-light text-dark border" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;">${hos.code || '---'}</span></td>
                    <td class="hospital-name">${hos.name}</td>
                    <td>
                        <div class="small"><i class="fas fa-map-marker-alt text-secondary me-1"></i> ${hos.address || '-'}</div>
                        <div class="small mt-1"><i class="fas fa-phone text-secondary me-1"></i> ${hos.phone || '-'}</div>
                    </td>
                    
                    <td>${adminDisplay}</td>
                    
                    <td class="text-center">${statusBadge}</td>
                    
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button onclick="openEditModal(${hos.id}, '${hos.name}', '${hos.address || ''}', '${hos.phone || ''}')" class="btn btn-sm btn-action btn-edit" title="S·ª≠a"><i class="fas fa-edit"></i></button>
                            ${statusBtn}
                            <button onclick="deleteHospital(${hos.id})" class="btn btn-sm btn-action btn-delete" title="X√≥a"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error("L·ªói loadHospitals:", err); }
        }

        async function createHospital() {
            const data = {
                hospitalCode: document.getElementById('hospitalCode').value,
                hospitalName: document.getElementById('hospitalName').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                adminUsername: document.getElementById('adminUsername').value,
                adminEmail: document.getElementById('adminEmail').value,
                adminPassword: document.getElementById('adminPassword').value
            };
            if (!data.hospitalCode || !data.hospitalName || !data.adminUsername || !data.adminPassword || !data.adminEmail) {
                return Swal.fire('Thi·∫øu th√¥ng tin', 'Nh·∫≠p ƒë·ªß c√°c tr∆∞·ªùng (*)', 'warning');
            }
            try {
                const res = await fetch('/api/super-admin/create-hospital', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ t·∫°o xong!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addHospitalModal')).hide();
                    loadHospitals();
                } else {
                    Swal.fire('L·ªói', (await res.json()).message, 'error');
                }
            } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
        }

        async function deleteHospital(id) {
            const token = localStorage.getItem('token');
            const result = await Swal.fire({
                title: 'X√≥a vƒ©nh vi·ªÖn?', text: "H√†nh ƒë·ªông n√†y s·∫Ω x√≥a B·ªánh vi·ªán v√† c·∫£ Admin c·ªßa vi·ªán ƒë√≥!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'X√≥a lu√¥n'
            });
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/super-admin/hospitals/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) { Swal.fire('ƒê√£ x√≥a', '', 'success'); loadHospitals(); }
                    else Swal.fire('L·ªói', 'Kh√¥ng x√≥a ƒë∆∞·ª£c', 'error');
                } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
            }
        }

        // Kh√≥a/M·ªü kh√≥a B·ªánh vi·ªán
        async function toggleStatus(id, currentStatus) {
            try {
                // üëá TH√äM D√íNG N√ÄY: L·∫•y token ƒë·ªÉ g·ª≠i l√™n server
                const token = localStorage.getItem('token');

                const res = await fetch(`/api/super-admin/hospital-status/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isActive: currentStatus })
                });

                if (res.ok) {
                    // Th√¥ng b√°o th√†nh c√¥ng r·ªìi m·ªõi load l·∫°i
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'success');
                    loadHospitals();
                } else {
                    const data = await res.json();
                    Swal.fire('L·ªói', data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi server', 'error');
            }
        }
        // --- 2. CH·ª®C NƒÇNG S·ª¨A B·ªÜNH VI·ªÜN ---
        function openEditModal(id, name, address, phone) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editAddress').value = address;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editNewPass').value = '';
            new bootstrap.Modal(document.getElementById('editHospitalModal')).show();
        }

        async function submitUpdate() {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('editName').value,
                address: document.getElementById('editAddress').value,
                phone: document.getElementById('editPhone').value,
                newPassword: document.getElementById('editNewPass').value
            };
            try {
                const res = await fetch(`/api/super-admin/hospitals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    Swal.fire('Th√†nh c√¥ng', 'C·∫≠p nh·∫≠t th√†nh c√¥ng', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editHospitalModal')).hide();
                    loadHospitals();
                } else Swal.fire('L·ªói', (await res.json()).message, 'error');
            } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
        }

        // --- 3. CH·ª®C NƒÇNG PROFILE (T√ÄI KHO·∫¢N C·ª¶A M√åNH) ---
        async function openProfileModal() {
            try {
                const res = await fetch('/api/users/profile', { headers: { 'Authorization': `Bearer ${token}` } }); // D√πng ƒë√∫ng endpoint userController
                const json = await res.json();
                if (res.ok) {
                    const user = json.user; // Ch√∫ √Ω: Backend userController tr·∫£ v·ªÅ { user: ... }
                    document.getElementById('myUsername').value = user.username;
                    document.getElementById('myFullName').value = user.fullName || '';
                    document.getElementById('myEmail').value = user.email || '';
                    document.getElementById('myEmployeeCode').value = user.employeeCode || '';
                    document.getElementById('myPhoneNumber').value = user.phoneNumber || '';
                    document.getElementById('myNewPass').value = '';
                    document.getElementById('myConfirmPass').value = '';
                    new bootstrap.Modal(document.getElementById('profileModal')).show();
                }
            } catch (e) { console.error(e); }
        }

        async function saveProfile() {
            // 1. L·∫•y d·ªØ li·ªáu t·ª´ √¥ nh·∫≠p
            const fullName = document.getElementById('myFullName').value;
            const email = document.getElementById('myEmail').value;
            const employeeCode = document.getElementById('myEmployeeCode').value;
            const phoneNumber = document.getElementById('myPhoneNumber').value;
            const newPass = document.getElementById('myNewPass').value;
            const confirmPass = document.getElementById('myConfirmPass').value;

            // Validate m·∫≠t kh·∫©u m·ªõi
            if (newPass && newPass.trim() !== '') {
                if (newPass !== confirmPass) {
                    Swal.fire('L·ªói', 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
                    return;
                }
            }

            // L·∫•y token (ƒë·∫£m b·∫£o bi·∫øn token ƒë√£ ƒë∆∞·ª£c khai b√°o ho·∫∑c l·∫•y t·ª´ localStorage)
            const token = localStorage.getItem('token');

            // Y√™u c·∫ßu nh·∫≠p pass c≈© ƒë·ªÉ b·∫£o m·∫≠t (Optional: n·∫øu backend kh√¥ng b·∫Øt bu·ªôc th√¨ c√≥ th·ªÉ b·ªè)
            // Nh∆∞ng hi·ªán t·∫°i b·∫°n ƒëang d√πng prompt, n√™n c·ª© gi·ªØ nguy√™n
            const currentPass = prompt("Nh·∫≠p m·∫≠t kh·∫©u HI·ªÜN T·∫†I ƒë·ªÉ x√°c nh·∫≠n thay ƒë·ªïi:");
            if (!currentPass) return; // N·∫øu b·∫•m h·ªßy th√¨ d·ª´ng l·∫°i

            try {
                // --- B∆Ø·ªöC 1: C·∫¨P NH·∫¨T TH√îNG TIN C√Å NH√ÇN ---
                // G√°n k·∫øt qu·∫£ v√†o bi·∫øn resInfo ƒë·ªÉ ki·ªÉm tra
                const resInfo = await fetch('/api/users/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ fullName, email, employeeCode, phoneNumber })
                });

                // üëá ƒê√ÇY L√Ä CH·ªñ QUAN TR·ªåNG B·∫†N THI·∫æU üëá
                if (!resInfo.ok) {
                    const errData = await resInfo.json();
                    throw new Error(errData.message || 'L·ªói c·∫≠p nh·∫≠t h·ªì s∆°');
                }

                // --- B∆Ø·ªöC 2: ƒê·ªîI M·∫¨T KH·∫®U (N·∫æU C√ì NH·∫¨P) ---
                if (newPass && newPass.trim() !== '') {
                    const resPass = await fetch('/api/users/change-password', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            currentPassword: currentPass,
                            newPassword: newPass
                        })
                    });

                    if (!resPass.ok) {
                        const errPass = await resPass.json();
                        throw new Error(errPass.message || 'L·ªói ƒë·ªïi m·∫≠t kh·∫©u');
                    }
                }

                // N·∫øu ch·∫°y ƒë·∫øn ƒë√¢y nghƒ©a l√† kh√¥ng c√≥ l·ªói n√†o
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° & m·∫≠t kh·∫©u!', 'success');

                // ƒê√≥ng modal sau khi l∆∞u th√†nh c√¥ng
                const modalEl = document.getElementById('profileModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) modalInstance.hide();

                // (T√πy ch·ªçn) Reload l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã ·ªü g√≥c
                // location.reload();

            } catch (e) {
                console.error(e);
                Swal.fire('Th·∫•t b·∫°i', e.message || 'L·ªói k·∫øt n·ªëi server', 'error');
            }
        }

        // --- 4. TI·ªÜN √çCH XEM QUY·ªÄN ---
        function showPermissions(username, role, permissions) {
            let htmlList = permissions.length === 0 ? '<p class="text-danger">Ch∆∞a c√≥ quy·ªÅn c·ª• th·ªÉ</p>' : '<ul class="text-start">';
            permissions.forEach(p => htmlList += `<li>${p}</li>`);
            if (permissions.length > 0) htmlList += '</ul>';

            Swal.fire({
                title: `Admin: ${username}`,
                html: `<p>Vai tr√≤: <strong>${role}</strong></p><hr>${htmlList}`,
                icon: 'info'
            });
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (e) { console.error('Logout error', e); }
            localStorage.clear();
            window.location.href = '/index.html';
        }

        loadHospitals();
    </script>
</body>

</html>